# Aegis AI → PDRI Integration Specification

## Overview

Aegis AI is the **detection sensor** (the "eyes") that monitors AI usage, shadow AI, and data exposure across the enterprise. PDRI is the **risk intelligence engine** (the "brain") that processes these signals into actionable risk insights.

**Key Principle**: Aegis and PDRI are internal components. Customers interact only with the unified Platform.

---

## Data Flow Architecture

```
┌────────────────────────────────────────────────────────────────────────┐
│                        CUSTOMER ENVIRONMENT                             │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐   │
│  │ SaaS Apps    │  │ Cloud (AWS/  │  │ On-Prem      │  │ Endpoints │   │
│  │ (O365, Slack)│  │ GCP/Azure)   │  │ Systems      │  │           │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └─────┬────┘   │
│         │                 │                 │                │         │
│         └─────────────────┼─────────────────┼────────────────┘         │
│                           ▼                                             │
│                  ┌─────────────────┐                                   │
│                  │   AEGIS AI      │                                   │
│                  │   SENSORS       │                                   │
│                  │                 │                                   │
│                  │  • API Gateway  │                                   │
│                  │  • Network Tap  │                                   │
│                  │  • Browser Ext  │                                   │
│                  │  • CASB Proxy   │                                   │
│                  └────────┬────────┘                                   │
│                           │                                             │
└───────────────────────────┼─────────────────────────────────────────────┘
                            │
                            ▼
              ┌──────────────────────────────┐
              │      KAFKA MESSAGE BUS       │
              │   Topic: security-events     │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │           PDRI               │
              │     (Risk Intelligence)      │
              └──────────────────────────────┘
```

---

## Security Event Schema (Aegis → Kafka → PDRI)

Every detection from Aegis produces a `SecurityEvent`:

```json
{
  "event_id": "evt-a1b2c3d4-5678-90ef-ghij-klmnopqrstuv",
  "event_type": "AI_DATA_ACCESS",
  "timestamp": "2024-01-15T14:30:00Z",
  "source_system_id": "aegis-sensor-prod-01",

  "target_entity_id": "datastore:customer-db",
  "identity_id": "service:chatgpt-integration",

  "exposure_direction": "internal_to_ai",
  "sensitivity_tags": ["financial_related", "identity_related"],
  "data_volume_estimate": 1048576,
  "privilege_level": "read",

  "metadata": {
    "ai_tool": {
      "name": "ChatGPT",
      "provider": "OpenAI",
      "deployment": "enterprise",
      "sanctioned": true
    },
    "access_context": {
      "query_type": "SELECT",
      "tables_accessed": ["customers", "transactions"],
      "row_count_estimate": 5000
    },
    "network": {
      "source_ip": "10.0.1.50",
      "destination_ip": "104.18.7.15",
      "protocol": "HTTPS"
    }
  }
}
```

---

## Event Types Generated by Aegis

| Event Type | Description | Risk Signal |
|------------|-------------|-------------|
| `AI_DATA_ACCESS` | AI tool accessed internal data | Data exposure to AI |
| `AI_PROMPT_SENSITIVE` | Sensitive data detected in AI prompt | PII/secrets in prompts |
| `AI_API_INTEGRATION` | New AI API connection detected | Shadow AI integration |
| `AI_AGENT_PRIV_ACCESS` | AI agent used elevated privileges | Privilege escalation |
| `UNSANCTIONED_AI_TOOL` | Unapproved AI tool detected | Shadow AI usage |
| `DATA_MOVEMENT` | Data transferred between systems | Data exfiltration risk |
| `DATA_EXPORT` | Data exported externally | DLP trigger |
| `PRIVILEGE_ESCALATION` | User/service gained higher access | Access control violation |

---

## What PDRI Does With Aegis Data

### 1. Graph Construction
Aegis events are transformed into graph relationships:

```cypher
// When Aegis detects: AI tool accessing database
MERGE (ai:AITool {id: $ai_tool_id, name: "ChatGPT"})
MERGE (db:DataStore {id: $datastore_id, name: "customer-db"})
MERGE (ai)-[r:ACCESSES {
  first_seen: $timestamp,
  last_seen: $timestamp,
  access_count: 1,
  data_volume: $volume,
  sensitivity_tags: $tags
}]->(db)
ON MATCH SET r.last_seen = $timestamp, r.access_count = r.access_count + 1
```

### 2. Risk Scoring
Each event updates entity risk scores:

- **Exposure Score**: Increases when AI tools access sensitive data
- **Volatility Score**: Increases with unusual access patterns
- **Sensitivity Score**: Based on data classification tags

### 3. Compliance Mapping
Events are mapped to compliance controls:

| Aegis Event | Compliance Impact |
|-------------|-------------------|
| `AI_DATA_ACCESS` to PII | GDPR Art. 32, HIPAA 164.312 |
| `UNSANCTIONED_AI_TOOL` | SOC2 CC6.1, ISO 8.1 |
| `DATA_EXPORT` | GDPR Art. 33, PCI-DSS 12.10 |

### 4. Finding Generation
High-risk patterns generate `RiskFinding` objects:

```json
{
  "finding_id": "f-abc12345",
  "title": "Shadow AI Tool Accessing Customer Database",
  "description": "Unsanctioned AI tool 'claude.ai' detected accessing customer-db containing PII...",
  "severity": "high",
  "risk_score": 0.85,
  "entities_involved": [
    {"entity_id": "ai:claude-browser", "role": "accessor"},
    {"entity_id": "datastore:customer-db", "role": "target"}
  ],
  "recommendations": [
    {
      "action": "block_ai_tool",
      "description": "Block unsanctioned AI tool at network level",
      "priority": "high"
    }
  ]
}
```

---

## Integration Points for Platform

The Platform Gateway should consume PDRI outputs via:

### REST API
```
GET  /api/v2/risk-findings              # Paginated findings
GET  /api/v2/risk-findings/{id}         # Finding details
GET  /api/v2/entities/{id}/risk-score   # Entity risk score
GET  /api/v2/compliance/assessment      # Compliance status
POST /api/v2/simulation/run             # Run what-if scenario
```

### WebSocket (Real-time)
```
WS   /ws/stream                         # Real-time findings stream
```

### Kafka Topics (Internal)
```
security-events         # Aegis → PDRI (input)
risk-findings           # PDRI → Platform (output)
risk-scores             # PDRI → Platform (output)
compliance-alerts       # PDRI → Platform (output)
```

---

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    KUBERNETES CLUSTER                            │
│                                                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │
│  │  platform-ui   │  │ platform-gw    │  │  aegis-sensor  │     │
│  │  (Frontend)    │  │ (API Gateway)  │  │  (Detection)   │     │
│  │  3 replicas    │  │  3 replicas    │  │  DaemonSet     │     │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘     │
│          │                   │                   │               │
│          └───────────────────┼───────────────────┘               │
│                              │                                   │
│                    ┌─────────┴─────────┐                        │
│                    │   Internal LB     │                        │
│                    └─────────┬─────────┘                        │
│                              │                                   │
│  ┌────────────────┐  ┌──────┴───────┐  ┌────────────────┐       │
│  │  pdri-api      │  │  pdri-worker │  │  pdri-ml       │       │
│  │  (REST API)    │  │  (Kafka)     │  │  (Inference)   │       │
│  │  3 replicas    │  │  5 replicas  │  │  2 replicas    │       │
│  └────────────────┘  └──────────────┘  └────────────────┘       │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    DATA LAYER                             │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│  │  │ Kafka    │  │ Neo4j    │  │ Postgres │  │ Redis    │  │   │
│  │  │ (Events) │  │ (Graph)  │  │ (History)│  │ (Cache)  │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```
